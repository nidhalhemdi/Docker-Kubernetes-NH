# **Adding Data Persistence to MongoDB with Volumes**

---

# ğŸ¯ **Main Goals**

1. **Persist MongoDB data** so that database contents survive container deletion.
2. **Secure MongoDB access** using username/password authentication.
3. **Update backend connection code** to match the new auth-enabled MongoDB setup.

---

# ğŸ”¥ Problem Without a Volume

When your MongoDB container stops, Docker **removes the container**, and all data stored inside the container disappears.

Example:

* You add a â€œgoalâ€
* Stop `mongodb` container
* Restart it again
  ğŸ‘‰ **Data is gone**

Because MongoDB stores its data inside the container at a specific path.

---

# ğŸ“¦ 1. Add Data Persistence Using a Named Volume

MongoDB stores its database files inside this folder in the container:

```
/data/db
```

To persist this folder, use a **named volume**:

```sh
docker run --name mongodb \
  --rm \
  --network goals-net \
  -v data:/data/db \
  mongo
```

Explanation:

* `data:` = volume name (Docker creates it automatically)
* `/data/db` = where MongoDB saves database files inside the container

Now:
âœ” Data persists across container restarts
âœ” The host machine stores the data (at an internal Docker-managed path)

---

# ğŸ” 2. Add Authentication (Username + Password)

MongoDB allows enabling authentication using environment variables:

```sh
-e MONGO_INITDB_ROOT_USERNAME=nidhal \
-e MONGO_INITDB_ROOT_PASSWORD=secret
```

Run MongoDB with volumes AND authentication:

```sh
docker run --name mongodb \
  --rm \
  --network goals-net \
  -v data:/data/db \
  -e MONGO_INITDB_ROOT_USERNAME=nidhal \
  -e MONGO_INITDB_ROOT_PASSWORD=secret \
  mongo
```

Now the DB requires login.

Result:

* Backend can no longer connect until credentials are added.

---

# ğŸ§  3. Update the Backend Connection String

MongoDB connection strings support embedding username/password:

Format:

```
mongodb://username:password@host:port
```

So update Node backend code:

```js
mongodb://nidhal:secret@mongodb:27017
```

But **authentication still fails**.

---

# âš  Why Does It Fail?

Because MongoDB stores admin credentials inside the **admin database**, and Mongoose does not automatically use it.

Mongo requires an extra parameter:

```
?authSource=admin
```

---

# âœ” Final Correct Connection String

```js
mongodb://nidhal:secret@mongodb:27017/yourdbname?authSource=admin
```

Example:

```js
mongoose.connect(
  "mongodb://nidhal:secret@mongodb:27017/goals?authSource=admin"
);
```

Now everything works:

* Backend can connect
* Data persists
* Authentication is enforced

---

# ğŸ” 4. Rebuild and Restart Backend

Since the backend code changed:

```sh
docker build -t goals-node .
```

Run backend again:

```sh
docker run --name goals-backend \
  --rm \
  --network goals-net \
  -p 80:80 \
  goals-node
```

Now:
âœ” Backend connects successfully
âœ” React app works again
âœ” Data persists
âœ” DB is protected

---

# ğŸ‰ **Final Result**

You now have a MongoDB container that:

* persists data using a named volume
* requires authentication
* works with the backend via a secure connection string
* runs inside the same Docker network as the backend

Everything is now production-like, even in development.
